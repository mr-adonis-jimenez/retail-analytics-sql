name: security-and-policy-enforcement

on:
  push:
    branches: [main]
    paths:
      - requirements.txt
      - SECURITY.md
      - LICENSE
      - .github/workflows/security-and-policy-enforcement.yml
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  dependency-check:
    name: security / dependency-scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install audit tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          pip install pip-audit

      - name: Scan dependencies
        run: |
          pip-audit -r requirements.txt --format json > security-report.json
          pip-audit -r requirements.txt --format markdown > security-report.md

      - name: Check outdated packages
        run: |
          pip install -r requirements.txt
          pip list --outdated --format json > outdated-packages.json
          pip list --outdated > outdated-report.md

      - name: Enforce severity gate
        run: |
          HIGH=$(jq '[.dependenci]()
