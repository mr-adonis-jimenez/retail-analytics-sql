name: Policy Enforcement

on:
  pull_request:
    branches:
      - main
      - release/**
      - develop
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write
  issues: write

concurrency:
  group: policy-${{ github.ref }}
  cancel-in-progress: true

env:
  ENVIRONMENT: ${{ vars.ENVIRONMENT || 'production' }}

jobs:
  enforce-policy:
    name: Policy / Enforce Standards
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Validate Branch Naming Convention
        if: github.event_name == 'pull_request'
        run: |
          BRANCH="${GITHUB_HEAD_REF}"
          echo "üîç Validating branch: $BRANCH"
          
          if [[ "$BRANCH" =~ ^(main|develop|release/v[0-9]+\.[0-9]+\.[0-9]+|feature/[a-z0-9-]+|bugfix/[a-z0-9-]+|hotfix/[a-z0-9-]+)$ ]]; then
            echo "‚úÖ Branch name is valid"
          else
            echo "‚ùå Invalid branch name: $BRANCH"
            echo "Valid patterns: main, develop, release/v*, feature/*, bugfix/*, hotfix/*"
            exit 1
          fi
          
      - name: Verify Commit Messages
        run: |
          echo "üìù Checking commit messages..."
          git log --format=%B origin/main..HEAD | while read -r msg; do
            if [[ -z "$msg" ]]; then continue; fi
            if [[ ! "$msg" =~ ^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\([a-z0-9-]+\))?:.*$ ]]; then
              echo "‚ùå Invalid commit message format: $msg"
              echo "Use conventional commits: type(scope): message"
              exit 1
            fi
          done
          echo "‚úÖ All commit messages follow conventions"
          
      - name: Check File Sizes
        run: |
          echo "üì¶ Checking for large files..."
          LARGE_FILES=$(find . -type f -size +5M -not -path "*/\.*" 2>/dev/null || true)
          if [ -n "$LARGE_FILES" ]; then
            echo "‚ùå Large files detected (>5MB):"
            echo "$LARGE_FILES"
            exit 1
          fi
          echo "‚úÖ No large files detected"
          
      - name: Validate YAML Files
        run: |
          echo "üîß Installing yamllint..."
          pip install yamllint
          echo "üìã Linting YAML files..."
          yamllint -d '{extends: default, rules: {line-length: {max: 120}}}' .github/ || exit 1
          echo "‚úÖ YAML files are valid"
          
      - name: Security - Dependency Vulnerability Scan
        uses: github/dependency-review-action@v4
        if: github.event_name == 'pull_request'
        with:
          fail-on-severity: moderate
          deny-licenses: GPL-2.0, GPL-3.0
          
      - name: Security - Secret Scanning
        run: |
          echo "üîê Scanning for exposed secrets..."
          # Check for common secret patterns
          if git diff origin/main..HEAD | grep -iE '(password|api[_-]?key|secret|token|private[_-]?key)\s*=\s*["'"'][^"'"']+["'"']'; then
            echo "‚ùå Potential secrets detected in commits"
            exit 1
          fi
          echo "‚úÖ No secrets detected"
          
      - name: Code Quality - SQL Files
        if: contains(github.event.head_commit.modified, '.sql')
        run: |
          echo "üîç Checking SQL files for quality..."
          # Check for dangerous SQL patterns
          if grep -r --include="*.sql" -iE "(DROP TABLE|TRUNCATE|DELETE FROM.*WHERE 1=1)" .; then
            echo "‚ö†Ô∏è  WARNING: Dangerous SQL patterns detected"
          fi
          echo "‚úÖ SQL quality check complete"
          
      - name: Notify Make.com Webhook
        if: always()
        continue-on-error: true
        run: |
          STATUS="${{ job.status }}"
          PAYLOAD=$(cat <<EOF
          {
            "workflow": "${{ github.workflow }}",
            "repository": "${{ github.repository }}",
            "branch": "${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}",
            "status": "$STATUS",
            "run_id": "${{ github.run_id }}",
            "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "actor": "${{ github.actor }}",
            "event": "${{ github.event_name }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          )
          
          if [ -n "${{ secrets.MAKE_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.MAKE_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" || echo "‚ö†Ô∏è  Webhook notification failed"
          else
            echo "‚ÑπÔ∏è  No webhook URL configured"
          fi
          
      - name: Policy Summary Report
        if: always()
        run: |
          echo "## üìä Policy Enforcement Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ All policy checks completed successfully!" >> $GITHUB_STEP_SUMMARY
